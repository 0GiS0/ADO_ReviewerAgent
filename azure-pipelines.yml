# Complete PR Analysis Pipeline with GitHub Copilot
# 
# âš ï¸  REQUIRED CONFIGURATION:
# 1. Go to your pipeline in Azure DevOps > Edit > Variables
# 2. Add new variable: AZURE_DEVOPS_EXT_PAT
# 3. Check "Keep this value secret" âœ…
# 4. Enter your Personal Access Token (PAT)
# 5. The PAT must have "Code (read)" and "Pull Request (contribute)" permissions
# 6. Install GitHub Copilot CLI on the agent or use an image that includes it
#
trigger: none

pr:
  branches:
    include:
      - main
      - develop
      - feature/*

pool:
  vmImage: ubuntu-latest

variables:
  - group: "GitHub Copilot CLI"
  - name: MODEL
    value: claude-sonnet-4
  - name: COPILOT_VERSION
    value: "latest"
  - name: ANALYSIS_DIR
    value: "$(Build.ArtifactStagingDirectory)/pr-analysis"
  - name: DIFF_FILE
    value: "$(Build.ArtifactStagingDirectory)/pr-diff.json"
  - name: COMMENT_FILE
    value: "pr-comment.md"

steps:
  - script: echo "ðŸš€ Starting complete PR analysis pipeline with GitHub Copilot"
    displayName: ðŸš€ Start

  - bash: |
      echo "ðŸ“‹ Pull Request Information:"
      echo "  - Repository URI: $(System.PullRequest.SourceRepositoryUri)"
      echo "  - PR #: $(System.PullRequest.PullRequestId)"
      echo "  - Source Branch: $(System.PullRequest.SourceBranch)"
      echo "  - Target Branch: $(System.PullRequest.TargetBranch)"
      echo "  - Source Commit: $(System.PullRequest.SourceCommitId)"
      echo "  - Build Repository: $(Build.Repository.Uri)"
      echo "  - Build Commit: $(Build.SourceVersion)"
      echo ""
      echo "ðŸ“ Working directories:"
      echo "  - Analysis Dir: $(ANALYSIS_DIR)"
      echo "  - Diff File: $(DIFF_FILE)"
      echo "  - Comment File: $(COMMENT_FILE)"
      
    displayName: ðŸ“‹ Show PR Information

  - task: NodeTool@0
    inputs:
      versionSource: "spec"
      versionSpec: "22.x"     
    displayName: âš™ï¸ Setup Node.js 22.x

  - bash: |
      NPM_PREFIX=$(npm config get prefix)
      echo "##vso[task.setvariable variable=NPM_GLOBAL_PATH]${NPM_PREFIX}/lib/node_modules"
      echo "NPM global path: ${NPM_PREFIX}/lib/node_modules"
    displayName: ðŸ” Detect NPM Global Path

  - task: Cache@2
    inputs:
      key: 'npm-global | "$(Agent.OS)" | "copilot" | "$(COPILOT_VERSION)"'
      path: $(NPM_GLOBAL_PATH)
      restoreKeys: |
        npm-global | "$(Agent.OS)" | "copilot"
    displayName: ðŸ“¦ Cache Global NPM Packages

  - bash: |
      if ! command -v copilot &> /dev/null; then
        echo "Installing @github/copilot..."
        npm install -g @github/copilot
      else
        echo "âœ… @github/copilot already installed (from cache)"
        copilot --version
      fi
    displayName: ðŸ“¦ Install Copilot CLI  

  - template: templates/run-script.yml
    parameters:
      script: get-pr-diff.sh
      args: '"$(System.PullRequest.SourceRepositoryUri)" "$(System.PullRequest.SourceBranch)" "$(System.PullRequest.TargetBranch)" "$(AZURE_DEVOPS_EXT_PAT)" "$(DIFF_FILE)"'
      displayName: ðŸ” Get PR Differences

  - template: templates/run-script.yml
    parameters:
      script: download-pr-files.sh
      args: '"$(DIFF_FILE)" "$(System.PullRequest.SourceRepositoryUri)" "$(System.PullRequest.SourceBranch)" "$(System.PullRequest.TargetBranch)" "$(AZURE_DEVOPS_EXT_PAT)" "$(ANALYSIS_DIR)"'
      displayName: ðŸ“ Download Modified Files

  - bash: |
      # Check if there are files to analyze
      if [ ! -d "$(ANALYSIS_DIR)/source" ] || [ -z "$(ls -A "$(ANALYSIS_DIR)/source" 2>/dev/null)" ]; then
        echo "âš ï¸  No files to analyze, creating empty comment"
        mkdir -p "$(ANALYSIS_DIR)/source"
        cat > "$(ANALYSIS_DIR)/source/pr-comment.md" << EOF
      # ðŸ“ Pull Request Analysis
      
      âš ï¸  **No files found to analyze in this PR.**
      
      This can happen if:
      - The PR only contains file deletions
      - Files could not be downloaded
      - The PR is empty
      
      **Status**: No files to review
      **Recommendation**: Manually verify the PR content
      EOF
      else
        echo "ðŸ¤– Running Copilot analysis..."
      fi
    displayName: ðŸ” Check Files to Analyze

  - template: templates/run-script.yml
    parameters:
      script: analyze-with-copilot.sh
      args: '"$(ANALYSIS_DIR)/source" "$(ANALYSIS_DIR)/source/pr-comment.md"'
      displayName: ðŸ¤– Analyze with GitHub Copilot CLI
      workingDirectory: $(System.DefaultWorkingDirectory)

  - bash: |
      echo "ï¿½ DISPLAY GENERATED ANALYSIS"
      echo "=============================="
      echo ""
      
      if [ -f "$(COMMENT_FILE)" ]; then
        echo "âœ… Analysis file found: $(COMMENT_FILE)"
        echo "ðŸ“Š File size: $(du -h "$(COMMENT_FILE)" | cut -f1)"
        echo "ðŸ“„ Lines: $(wc -l < "$(COMMENT_FILE)")"
        echo "ðŸ“ Characters: $(wc -c < "$(COMMENT_FILE)")"
        echo ""
        echo "ðŸ“‹ CONTENT PREVIEW:"
        echo "==================="
        
        # Show first 50 lines of the analysis
        head -50 "$(ANALYSIS_DIR)/source/pr-comment.md" || cat "$(ANALYSIS_DIR)/source/pr-comment.md"
        
        # If file is longer than 50 lines, show indication
        TOTAL_LINES=$(wc -l < "$(ANALYSIS_DIR)/source/pr-comment.md")
        if [ $TOTAL_LINES -gt 50 ]; then
          echo ""
          echo "... (showing first 50 lines of $TOTAL_LINES total lines)"
          echo ""
          echo "ðŸ“‹ LAST 10 LINES:"
          echo "=================="
          tail -10 "$(ANALYSIS_DIR)/source/pr-comment.md"
        fi
        
        echo ""
        echo "âœ… Analysis content verified"
      else
        echo "âŒ ERROR: Analysis file not found: $(ANALYSIS_DIR)/source/pr-comment.md"
        echo "ðŸ” Files in staging directory:"
        ls -la "$(Build.ArtifactStagingDirectory)" || echo "Directory not found"
      fi
      
    displayName: ðŸ“„ Display Generated Analysis

  - bash: |
      # Extract repository information
      REPO_URI="$(System.PullRequest.SourceRepositoryUri)"
      ORG=$(echo "$REPO_URI" | sed 's|https://[^@]*@||' | awk -F'/' '{print $2}')
      PROJECT=$(echo "$REPO_URI" | sed 's|https://[^@]*@||' | awk -F'/' '{print $3}' | sed 's/%20/ /g' | sed 's/ /%20/g')
      REPO=$(echo "$REPO_URI" | sed 's|https://[^@]*@||' | awk -F'/' '{print $5}')
      PR_ID="$(System.PullRequest.PullRequestId)"
      
      echo "ðŸ” Repository information:"
      echo "  - Organization: $ORG"
      echo "  - Project: $PROJECT"
      echo "  - Repository: $REPO"
      echo "  - PR ID: $PR_ID"
      
      echo "##vso[task.setvariable variable=PR_ORG]$ORG"
      echo "##vso[task.setvariable variable=PR_PROJECT]$PROJECT"
      echo "##vso[task.setvariable variable=PR_REPO]$REPO"
      echo "##vso[task.setvariable variable=PR_NUM]$PR_ID"
    displayName: ðŸ“‹ Extract PR Info

  - template: templates/run-script.yml
    parameters:
      script: post-pr-comment.sh
      args: '"$(ANALYSIS_DIR)/source/pr-comment.md" "$(PR_ORG)" "$(PR_PROJECT)" "$(PR_REPO)" "$(PR_NUM)" "$(AZURE_DEVOPS_EXT_PAT)"'
      displayName: ðŸ’¬ Publish Comment on PR

  - bash: |
      echo "ðŸ“Š COMPLETE ANALYSIS SUMMARY"
      echo "==============================="
      echo ""
      echo "ðŸ“‹ PR Information:"
      echo "  - PR #: $(System.PullRequest.PullRequestId)"
      echo "  - Source Branch: $(System.PullRequest.SourceBranch)"
      echo "  - Target Branch: $(System.PullRequest.TargetBranch)"
      echo ""
      
      # Show diff statistics
      if [ -f "$(DIFF_FILE)" ]; then
        echo "ðŸ” Diff statistics:"
        echo "  - Diff file: $(DIFF_FILE)"
        echo "  - Size: $(du -h "$(DIFF_FILE)" | cut -f1)"
        
        if command -v jq &> /dev/null && jq empty "$(DIFF_FILE)" 2>/dev/null; then
          echo "  - Total changes: $(jq '.changes | length' "$(DIFF_FILE)" 2>/dev/null || echo 'N/A')"
          echo "  - Added files: $(jq '.changeCounts.Add // 0' "$(DIFF_FILE)" 2>/dev/null)"
          echo "  - Edited files: $(jq '.changeCounts.Edit // 0' "$(DIFF_FILE)" 2>/dev/null)"
          echo "  - Deleted files: $(jq '.changeCounts.Delete // 0' "$(DIFF_FILE)" 2>/dev/null)"
        fi
      fi
      
      # Show downloaded files statistics
      if [ -d "$(ANALYSIS_DIR)" ]; then
        echo ""
        echo "ðŸ“ Downloaded files:"
        echo "  - Directory: $(ANALYSIS_DIR)"
        echo "  - Source files: $(find "$(ANALYSIS_DIR)/source" -type f 2>/dev/null | wc -l)"
        echo "  - Target files: $(find "$(ANALYSIS_DIR)/target" -type f 2>/dev/null | wc -l)"
      fi
      
      # Show comment information
      if [ -f "$(ANALYSIS_DIR)/source/pr-comment.md" ]; then
        echo ""
        echo "ðŸ’¬ Generated comment:"
        echo "  - File: $(ANALYSIS_DIR)/source/pr-comment.md"
        echo "  - Size: $(du -h "$(ANALYSIS_DIR)/source/pr-comment.md" | cut -f1)"
        echo "  - Lines: $(wc -l < "$(ANALYSIS_DIR)/source/pr-comment.md")"
        echo "  - Characters: $(wc -c < "$(ANALYSIS_DIR)/source/pr-comment.md")"
      fi
      
    displayName: ðŸ“Š Show Final Summary

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: "$(Build.ArtifactStagingDirectory)"
      ArtifactName: "pr-analysis-complete"
      publishLocation: "Container"
    displayName: ðŸ“¦ Publish Complete Analysis as Artifact
