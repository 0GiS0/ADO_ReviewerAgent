# Pipeline de AnÃ¡lisis Completo de PR con GitHub Copilot
# 
# âš ï¸  CONFIGURACIÃ“N REQUERIDA:
# 1. Ve a tu pipeline en Azure DevOps > Edit > Variables
# 2. Agrega nueva variable: AZURE_DEVOPS_EXT_PAT
# 3. Marca "Keep this value secret" âœ…
# 4. Ingresa tu Personal Access Token (PAT)
# 5. El PAT debe tener permisos de "Code (read)" y "Pull Request (contribute)"
# 6. Instalar GitHub Copilot CLI en el agente o usar imagen que lo incluya
#
trigger: none

pr:
  branches:
    include:
      - main
      - develop
      - feature/*

pool:
  vmImage: ubuntu-latest

variables:
  - group: "GitHub Copilot CLI"
  - name: ANALYSIS_DIR
    value: "$(Build.ArtifactStagingDirectory)/pr-analysis"
  - name: DIFF_FILE
    value: "$(Build.ArtifactStagingDirectory)/pr-diff.json"
  - name: COMMENT_FILE
    value: "$(Build.ArtifactStagingDirectory)/pr-comment.md"

steps:
  - script: echo "ðŸš€ Iniciando pipeline de anÃ¡lisis completo de PR con GitHub Copilot"
    displayName: ðŸš€ Inicio

  - bash: |
      echo "ðŸ“‹ InformaciÃ³n del Pull Request:"
      echo "  - Repository URI: $(System.PullRequest.SourceRepositoryUri)"
      echo "  - PR #: $(System.PullRequest.PullRequestId)"
      echo "  - Source Branch: $(System.PullRequest.SourceBranch)"
      echo "  - Target Branch: $(System.PullRequest.TargetBranch)"
      echo "  - Source Commit: $(System.PullRequest.SourceCommitId)"
      echo "  - Build Repository: $(Build.Repository.Uri)"
      echo "  - Build Commit: $(Build.SourceVersion)"
      echo ""
      echo "ðŸ“ Directorios de trabajo:"
      echo "  - Analysis Dir: $(ANALYSIS_DIR)"
      echo "  - Diff File: $(DIFF_FILE)"
      echo "  - Comment File: $(COMMENT_FILE)"
      
    displayName: ðŸ“‹ Mostrar InformaciÃ³n del PR

  - bash: |
      echo "ðŸ”§ Instalando dependencias necesarias..."
      
      # Verificar e instalar jq si no estÃ¡ disponible
      if ! command -v jq &> /dev/null; then
        echo "ðŸ“¦ Instalando jq..."
        sudo apt-get update && sudo apt-get install -y jq
      else
        echo "âœ… jq ya estÃ¡ instalado: $(jq --version)"
      fi
      
      # Verificar GitHub Copilot CLI
      if ! command -v copilot &> /dev/null; then
        echo "âŒ GitHub Copilot CLI no estÃ¡ instalado"
        echo "â„¹ï¸  Este paso fallarÃ¡ si Copilot CLI no estÃ¡ disponible en el agente"
        echo "ðŸ’¡ Considera usar un agente personalizado con Copilot CLI preinstalado"
        exit 1
      else
        echo "âœ… GitHub Copilot CLI estÃ¡ disponible: $(copilot --version)"
      fi
      
      # Crear directorios necesarios
      mkdir -p "$(ANALYSIS_DIR)"
      
      echo "âœ… Dependencias verificadas"
      
    displayName: ðŸ”§ Verificar Dependencias

  - bash: |
      echo "ðŸ” PASO 1: Obteniendo diferencias del PR..."
      
      # Verificar que el script existe
      if [ ! -f "./scripts/get-pr-diff.sh" ]; then
        echo "âŒ ERROR: Script get-pr-diff.sh no encontrado"
        ls -la ./scripts/
        exit 1
      fi
      
      # Verificar que el PAT estÃ© disponible
      if [ -z "$AZURE_DEVOPS_EXT_PAT" ]; then
        echo "âŒ CRÃTICO: AZURE_DEVOPS_EXT_PAT no estÃ¡ configurado"
        echo "ðŸ“ Configura el PAT en las variables de la pipeline"
        exit 1
      fi
      
      # Ejecutar el script
      echo "ðŸ“¡ Ejecutando get-pr-diff.sh..."
      ./scripts/get-pr-diff.sh \
        "$(System.PullRequest.SourceRepositoryUri)" \
        "$(System.PullRequest.SourceBranch)" \
        "$(System.PullRequest.TargetBranch)" \
        "$(AZURE_DEVOPS_EXT_PAT)" \
        "$(DIFF_FILE)"
      
      if [ $? -eq 0 ] && [ -f "$(DIFF_FILE)" ]; then
        echo "âœ… Diferencias obtenidas exitosamente"
        echo "ðŸ“Š TamaÃ±o: $(du -h "$(DIFF_FILE)" | cut -f1)"
      else
        echo "âŒ ERROR: FallÃ³ la obtenciÃ³n del diff"
        exit 1
      fi
      
    displayName: ðŸ” Paso 1 - Obtener Diferencias del PR
    env:
      AZURE_DEVOPS_EXT_PAT: $(AZURE_DEVOPS_EXT_PAT)

  - bash: |
      echo "ðŸ“ PASO 2: Descargando archivos modificados..."
      
      # Verificar que el script existe
      if [ ! -f "./scripts/download-pr-files.sh" ]; then
        echo "âŒ ERROR: Script download-pr-files.sh no encontrado"
        exit 1
      fi
      
      # Verificar que existe el archivo diff
      if [ ! -f "$(DIFF_FILE)" ]; then
        echo "âŒ ERROR: Archivo diff no encontrado: $(DIFF_FILE)"
        exit 1
      fi
      
      # Ejecutar el script de descarga
      echo "ï¿½ Ejecutando download-pr-files.sh..."
      ./scripts/download-pr-files.sh \
        "$(DIFF_FILE)" \
        "$(System.PullRequest.SourceRepositoryUri)" \
        "$(System.PullRequest.SourceBranch)" \
        "$(System.PullRequest.TargetBranch)" \
        "$(AZURE_DEVOPS_EXT_PAT)" \
        "$(ANALYSIS_DIR)"
      
      if [ $? -eq 0 ] && [ -d "$(ANALYSIS_DIR)/source" ]; then
        echo "âœ… Archivos descargados exitosamente"
        echo "ðŸ“Š Archivos en source: $(find "$(ANALYSIS_DIR)/source" -type f | wc -l)"
      else
        echo "âŒ ERROR: FallÃ³ la descarga de archivos"
        exit 1
      fi
      
    displayName: ðŸ“ Paso 2 - Descargar Archivos Modificados
    env:
      AZURE_DEVOPS_EXT_PAT: $(AZURE_DEVOPS_EXT_PAT)

  - bash: |
      echo "ðŸ¤– PASO 3: Analizando archivos con GitHub Copilot CLI..."
      
      # Verificar que el script existe
      if [ ! -f "./scripts/analyze-with-copilot.sh" ]; then
        echo "âŒ ERROR: Script analyze-with-copilot.sh no encontrado"
        exit 1
      fi
      
      # Verificar que existen archivos para analizar
      if [ ! -d "$(ANALYSIS_DIR)/source" ] || [ -z "$(ls -A "$(ANALYSIS_DIR)/source" 2>/dev/null)" ]; then
        echo "âš ï¸  No hay archivos para analizar, creando comentario vacÃ­o"
        cat > "$(COMMENT_FILE)" << EOF
      # ðŸ“ AnÃ¡lisis de Pull Request
      
      âš ï¸  **No se encontraron archivos para analizar en este PR.**
      
      Esto puede ocurrir si:
      - El PR solo contiene eliminaciones de archivos
      - Los archivos no se pudieron descargar
      - El PR estÃ¡ vacÃ­o
      
      **Estado**: Sin archivos que revisar
      **RecomendaciÃ³n**: Verificar manualmente el contenido del PR
      EOF
        exit 0
      fi
      
      # Ejecutar el anÃ¡lisis con Copilot
      echo "ðŸ” Ejecutando analyze-with-copilot.sh..."
      ./scripts/analyze-with-copilot.sh \
        "$(ANALYSIS_DIR)/source" \
        "$(COMMENT_FILE)"
      
      if [ $? -eq 0 ] && [ -f "$(COMMENT_FILE)" ]; then
        echo "âœ… AnÃ¡lisis completado exitosamente"
        echo "ðŸ“Š TamaÃ±o del comentario: $(du -h "$(COMMENT_FILE)" | cut -f1)"
      else
        echo "âš ï¸  AnÃ¡lisis fallÃ³, creando comentario de error"
        cat > "$(COMMENT_FILE)" << EOF
      # âŒ Error en el AnÃ¡lisis de PR
      
      **Error**: El anÃ¡lisis automÃ¡tico con GitHub Copilot CLI fallÃ³.
      
      **Posibles causas:**
      - GitHub Copilot CLI no estÃ¡ disponible en el agente
      - Problemas de conectividad
      - Archivos no vÃ¡lidos para anÃ¡lisis
      
      **AcciÃ³n requerida**: RevisiÃ³n manual del Pull Request
      EOF
      fi
      
    displayName: ðŸ¤– Paso 3 - Analizar con GitHub Copilot CLI

  - bash: |
      echo "ï¿½ PASO 4: Publicando comentario en la PR..."
      
      # Verificar que el script existe
      if [ ! -f "./scripts/post-pr-comment.sh" ]; then
        echo "âŒ ERROR: Script post-pr-comment.sh no encontrado"
        exit 1
      fi
      
      # Verificar que existe el archivo de comentario
      if [ ! -f "$(COMMENT_FILE)" ]; then
        echo "âŒ ERROR: Archivo de comentario no encontrado: $(COMMENT_FILE)"
        exit 1
      fi
      
      # Extraer informaciÃ³n del repositorio
      REPO_URI="$(System.PullRequest.SourceRepositoryUri)"
      ORG=$(echo "$REPO_URI" | sed 's|https://[^@]*@||' | awk -F'/' '{print $2}')
      PROJECT=$(echo "$REPO_URI" | sed 's|https://[^@]*@||' | awk -F'/' '{print $3}' | sed 's/%20/ /g')
      REPO=$(echo "$REPO_URI" | sed 's|https://[^@]*@||' | awk -F'/' '{print $5}')
      PR_ID="$(System.PullRequest.PullRequestId)"
      
      echo "ðŸ” InformaciÃ³n del repositorio:"
      echo "  - OrganizaciÃ³n: $ORG"
      echo "  - Proyecto: $PROJECT"
      echo "  - Repositorio: $REPO"
      echo "  - PR ID: $PR_ID"
      
      # Ejecutar el script de publicaciÃ³n
      echo "ðŸ“¤ Ejecutando post-pr-comment.sh..."
      ./scripts/post-pr-comment.sh \
        "$(COMMENT_FILE)" \
        "$ORG" \
        "$PROJECT" \
        "$REPO" \
        "$PR_ID" \
        "$(AZURE_DEVOPS_EXT_PAT)"
      
      if [ $? -eq 0 ]; then
        echo "âœ… Comentario publicado exitosamente en PR #$PR_ID"
      else
        echo "âŒ ERROR: FallÃ³ la publicaciÃ³n del comentario"
        echo "â„¹ï¸  El anÃ¡lisis estÃ¡ disponible en los artefactos"
        # No fallar la pipeline, solo el comentario
      fi
      
    displayName: ðŸ’¬ Paso 4 - Publicar Comentario en PR
    env:
      AZURE_DEVOPS_EXT_PAT: $(AZURE_DEVOPS_EXT_PAT)

  - bash: |
      echo "ï¿½ RESUMEN DEL ANÃLISIS COMPLETO"
      echo "==============================="
      echo ""
      echo "ï¿½ InformaciÃ³n del PR:"
      echo "  - PR #: $(System.PullRequest.PullRequestId)"
      echo "  - Source Branch: $(System.PullRequest.SourceBranch)"
      echo "  - Target Branch: $(System.PullRequest.TargetBranch)"
      echo ""
      
      # Mostrar estadÃ­sticas del diff
      if [ -f "$(DIFF_FILE)" ]; then
        echo "ðŸ” EstadÃ­sticas del diff:"
        echo "  - Archivo diff: $(DIFF_FILE)"
        echo "  - TamaÃ±o: $(du -h "$(DIFF_FILE)" | cut -f1)"
        
        if command -v jq &> /dev/null && jq empty "$(DIFF_FILE)" 2>/dev/null; then
          echo "  - Total cambios: $(jq '.changes | length' "$(DIFF_FILE)" 2>/dev/null || echo 'N/A')"
          echo "  - Archivos aÃ±adidos: $(jq '.changeCounts.Add // 0' "$(DIFF_FILE)" 2>/dev/null)"
          echo "  - Archivos editados: $(jq '.changeCounts.Edit // 0' "$(DIFF_FILE)" 2>/dev/null)"
          echo "  - Archivos eliminados: $(jq '.changeCounts.Delete // 0' "$(DIFF_FILE)" 2>/dev/null)"
        fi
      fi
      
      # Mostrar estadÃ­sticas de archivos descargados
      if [ -d "$(ANALYSIS_DIR)" ]; then
        echo ""
        echo "ðŸ“ Archivos descargados:"
        echo "  - Directorio: $(ANALYSIS_DIR)"
        echo "  - Archivos fuente: $(find "$(ANALYSIS_DIR)/source" -type f 2>/dev/null | wc -l)"
        echo "  - Archivos destino: $(find "$(ANALYSIS_DIR)/target" -type f 2>/dev/null | wc -l)"
      fi
      
      # Mostrar informaciÃ³n del comentario
      if [ -f "$(COMMENT_FILE)" ]; then
        echo ""
        echo "ðŸ’¬ Comentario generado:"
        echo "  - Archivo: $(COMMENT_FILE)"
        echo "  - TamaÃ±o: $(du -h "$(COMMENT_FILE)" | cut -f1)"
        echo "  - LÃ­neas: $(wc -l < "$(COMMENT_FILE)")"
        echo "  - Caracteres: $(wc -c < "$(COMMENT_FILE)")"
      fi
      
    displayName: ðŸ“Š Mostrar Resumen Final

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: "$(Build.ArtifactStagingDirectory)"
      ArtifactName: "pr-analysis-complete"
      publishLocation: "Container"
    displayName: ï¿½ Publicar AnÃ¡lisis Completo como Artefacto

  - bash: |
      echo ""
      echo "ðŸŽ‰ PIPELINE COMPLETADA EXITOSAMENTE"
      echo "=================================="
      echo ""
      echo "âœ… Pasos ejecutados:"
      echo "  1. âœ… ObtenciÃ³n de diferencias del PR"
      echo "  2. âœ… Descarga de archivos modificados"
      echo "  3. âœ… AnÃ¡lisis con GitHub Copilot CLI"
      echo "  4. âœ… PublicaciÃ³n de comentario en PR"
      echo ""
      echo "ï¿½ Artefactos disponibles:"
      echo "  - pr-analysis-complete: Contiene diff, archivos y anÃ¡lisis completo"
      echo ""
      echo "ï¿½ Enlaces Ãºtiles:"
      echo "  - Ver PR: https://dev.azure.com/$(System.TeamFoundationCollectionUri | sed 's|https://||' | sed 's|/||')/$(System.TeamProject)/_git/$(Build.Repository.Name)/pullrequest/$(System.PullRequest.PullRequestId)"
      echo "  - Ver build: $(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"
      echo ""
      echo "ðŸ’¡ El comentario de revisiÃ³n ha sido publicado automÃ¡ticamente en la PR"
      
    displayName: ðŸŽ‰ Pipeline Completada


