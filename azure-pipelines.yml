# Pipeline Simplificada - Obtener Diferencias de PR
trigger: none

pr:
  branches:
    include:
      - main
      - develop
      - feature/*

pool:
  vmImage: ubuntu-latest

variables:
  - name: DIFF_OUTPUT
    value: "$(Build.ArtifactStagingDirectory)/pr-diff.txt"

steps:
  - script: echo "üöÄ Iniciando pipeline para obtener diferencias del PR"
    displayName: üöÄ Inicio

  - bash: |
      echo "üìã Informaci√≥n del Pull Request:"
      echo "  - Repository URI: $(System.PullRequest.SourceRepositoryUri)"
      echo "  - PR #: $(System.PullRequest.PullRequestId)"
      echo "  - Source Branch: $(System.PullRequest.SourceBranch)"
      echo "  - Target Branch: $(System.PullRequest.TargetBranch)"
      echo "  - Source Commit: $(System.PullRequest.SourceCommitId)"
      echo "  - Target Commit: $(System.PullRequest.TargetCommitId)"
      echo ""      
      
    displayName: üìã Mostrar Informaci√≥n del PR

  - bash: |
      echo "üì• Clonar repositorio fuente del PR..."
      
      # Obtener la URI del repositorio fuente
      SOURCE_REPO_URI="$(System.PullRequest.SourceRepositoryUri)"
      echo "Repositorio fuente: $SOURCE_REPO_URI"
      
      # Insertar el PAT en la URL
      # Convertir https://user@domain.com/path a https://PAT@domain.com/path
      if [[ "$SOURCE_REPO_URI" == *"@"* ]]; then
        # Si ya tiene un usuario, reemplazarlo con el PAT
        AUTH_URL=$(echo "$SOURCE_REPO_URI" | sed "s|https://[^@]*@|https://$(AZURE_DEVOPS_EXT_PAT)@|")
      else
        # Si no tiene usuario, agregar el PAT
        AUTH_URL=$(echo "$SOURCE_REPO_URI" | sed "s|https://|https://$(AZURE_DEVOPS_EXT_PAT)@|")
      fi
      
      echo "Clonando con autenticaci√≥n..."
      git clone "$AUTH_URL" source-repo

    displayName: üì• Clonar Repositorio Fuente
    env:
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)
      AZURE_DEVOPS_EXT_PAT: $(AZURE_DEVOPS_EXT_PAT)

  - bash: |
      echo "Usar git diff para ver diferencias entre ramas..."
      echo ""

      cd source-repo || { echo "‚ùå ERROR: No se pudo cambiar al directorio source-repo"; exit 1; }
      

      git fetch origin
      git --no-pager diff origin/main..origin/copilot/465 > "$(DIFF_OUTPUT)" || { echo "‚ùå ERROR: Fall√≥ el comando git diff"; exit 1; }


      echo "‚úÖ Diff generado exitosamente en: $(DIFF_OUTPUT)"
    displayName: üîç Obtener Diferencias del PR

  - bash: |
      echo "üìÑ Resumen del an√°lisis:"
      echo "  - Archivo de diferencias: $(DIFF_OUTPUT)"
      if [ -f "$(DIFF_OUTPUT)" ]; then
        echo "  - Tama√±o: $(du -h "$(DIFF_OUTPUT)" | cut -f1)"
        echo "  - L√≠neas: $(wc -l < "$(DIFF_OUTPUT)")"
        echo "‚úÖ Diff generado correctamente"
      else
        echo "‚ùå ERROR: No se gener√≥ el archivo de diferencias"
        exit 1
      fi
    displayName: üìÑ Mostrar Resumen

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: "$(Build.ArtifactStagingDirectory)"
      ArtifactName: "pr-diff"
      publishLocation: "Container"
    displayName: üì¶ Publicar Diff como Artefacto

  - bash: |
      echo "‚úÖ Pipeline completada exitosamente"
      echo "üìÅ El diff est√° disponible en los artefactos como 'pr-diff'"
    displayName: ‚úÖ Completado
