# Pipeline Simplificada - Obtener Diferencias de PR
trigger: none

pr:
  branches:
    include:
      - main
      - develop
      - feature/*

pool:
  vmImage: ubuntu-latest

variables:
  - name: DIFF_OUTPUT
    value: "$(Build.ArtifactStagingDirectory)/pr-diff.txt"

steps:
  - script: echo "ðŸš€ Iniciando pipeline para obtener diferencias del PR"
    displayName: ðŸš€ Inicio

  - bash: |
      echo "ðŸ“‹ InformaciÃ³n del Pull Request:"
      echo "  - Repository URI: $(System.PullRequest.SourceRepositoryUri)"
      echo "  - PR #: $(System.PullRequest.PullRequestId)"
      echo "  - Source Branch: $(System.PullRequest.SourceBranch)"
      echo "  - Target Branch: $(System.PullRequest.TargetBranch)"
      echo "  - Source Commit: $(System.PullRequest.SourceCommitId)"
      echo "  - Target Commit: $(System.PullRequest.TargetCommitId)"
      echo ""
      
      # Extraer el nombre del repositorio fuente
      SOURCE_REPO_URI="$(System.PullRequest.SourceRepositoryUri)"
      if [ -n "$SOURCE_REPO_URI" ]; then
        SOURCE_REPO_NAME=$(echo "$SOURCE_REPO_URI" | sed 's|.*/||')
        echo "  - Repositorio fuente: $SOURCE_REPO_NAME"
        echo "##vso[task.setvariable variable=SOURCE_REPO_NAME]$SOURCE_REPO_NAME"
      else
        echo "âŒ ERROR: System.PullRequest.SourceRepositoryUri estÃ¡ vacÃ­o"
        exit 1
      fi
    displayName: ðŸ“‹ Mostrar InformaciÃ³n del PR

  - bash: |
      echo "ðŸ“¥ Analizando repositorio fuente..."
      
      # Obtener la URI del repositorio fuente
      SOURCE_REPO_URI="$(System.PullRequest.SourceRepositoryUri)"
      echo "URI original: $SOURCE_REPO_URI"
      
      # En Azure DevOps, el agente ya descarga el repositorio automÃ¡ticamente
      # Solo necesitamos configurar la autenticaciÃ³n para operaciones adicionales
      if [ -n "$AZURE_DEVOPS_EXT_PAT" ]; then
        echo "Configurando autenticaciÃ³n con PAT"
        git config --global credential.helper store
        echo "https://:$AZURE_DEVOPS_EXT_PAT@dev.azure.com" > ~/.git-credentials
      else
        echo "Configurando autenticaciÃ³n con System.AccessToken"  
        git config --global credential.helper store
        echo "https://:$(System.AccessToken)@dev.azure.com" > ~/.git-credentials
      fi
      
      echo "ðŸ“‹ InformaciÃ³n del repositorio actual:"
      echo "  - Working directory: $(pwd)"
      echo "  - Git status disponible: $(git status --porcelain >/dev/null 2>&1 && echo 'SÃ­' || echo 'No')"
      
      echo "ðŸ“‹ Remotes configurados:"
      git remote -v 2>/dev/null || echo "No hay remotes configurados"
      
      echo "ðŸ“‹ Branches disponibles:"
      git branch -a 2>/dev/null || echo "No se pueden listar branches"
      
      echo "ðŸ“‹ InformaciÃ³n del commit:"
      echo "  - Commit actual: $(git rev-parse HEAD 2>/dev/null || echo 'No disponible')"
      echo "  - Branch actual: $(git branch --show-current 2>/dev/null || echo 'No disponible')"
      
      # Si el repositorio fuente es diferente al actual, intentar agregarlo como remote
      CURRENT_REPO_URI="$(Build.Repository.Uri)"
      if [ "$SOURCE_REPO_URI" != "$CURRENT_REPO_URI" ]; then
        echo "âš ï¸  El repositorio fuente es diferente al pipeline repository"
        echo "   - Pipeline repo: $CURRENT_REPO_URI"
        echo "   - Source repo: $SOURCE_REPO_URI"
        
        echo "ðŸ”„ Agregando repositorio fuente como remote..."
        git remote add source-repo "$SOURCE_REPO_URI" 2>/dev/null || echo "No se pudo agregar remote (podrÃ­a ya existir)"
        git fetch source-repo 2>/dev/null || echo "No se pudo hacer fetch del source repo"
      else
        echo "âœ… El repositorio fuente es el mismo que el pipeline repository"
      fi
    displayName: ï¿½ Clonar Repositorio Fuente
    env:
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)
      AZURE_DEVOPS_EXT_PAT: $(AZURE_DEVOPS_EXT_PAT)

  - bash: |
      echo "ðŸ” Obteniendo diferencias entre branches..."
      
      TARGET_BRANCH="$(System.PullRequest.TargetBranch)"
      SOURCE_BRANCH="$(System.PullRequest.SourceBranch)"
      
      # Remover prefijos refs/heads/ si existen
      TARGET_BRANCH_CLEAN=$(echo "$TARGET_BRANCH" | sed 's|refs/heads/||')
      SOURCE_BRANCH_CLEAN=$(echo "$SOURCE_BRANCH" | sed 's|refs/heads/||')
      
      echo "  - Target Branch: $TARGET_BRANCH_CLEAN"
      echo "  - Source Branch: $SOURCE_BRANCH_CLEAN"
      
      # Asegurarse de que tenemos los branches localmente
      git fetch origin "$TARGET_BRANCH_CLEAN" || echo "No se pudo hacer fetch del target branch"
      git fetch origin "$SOURCE_BRANCH_CLEAN" || echo "No se pudo hacer fetch del source branch"
      
      # Checkout al source branch
      git checkout "$SOURCE_BRANCH_CLEAN" || git checkout -b "$SOURCE_BRANCH_CLEAN" "origin/$SOURCE_BRANCH_CLEAN"
      
      echo ""
      echo "ðŸ“Š Archivos modificados:"
      git diff --name-only "origin/$TARGET_BRANCH_CLEAN"..."$SOURCE_BRANCH_CLEAN" | head -20
      
      echo ""
      echo "ï¿½ Generando diff completo..."
      git diff "origin/$TARGET_BRANCH_CLEAN"..."$SOURCE_BRANCH_CLEAN" > "$(DIFF_OUTPUT)"
      
      # Mostrar estadÃ­sticas
      echo ""
      echo "ðŸ“Š EstadÃ­sticas del diff:"
      echo "  - LÃ­neas en el diff: $(wc -l < "$(DIFF_OUTPUT)")"
      echo "  - TamaÃ±o del archivo: $(du -h "$(DIFF_OUTPUT)" | cut -f1)"
      
      # Mostrar las primeras lÃ­neas del diff
      echo ""
      echo "ðŸ“‹ Primeras 50 lÃ­neas del diff:"
      head -50 "$(DIFF_OUTPUT)"
      
      echo ""
      echo "âœ… Diff generado exitosamente en: $(DIFF_OUTPUT)"
    displayName: ðŸ” Obtener Diferencias del PR

  - bash: |
      echo "ðŸ“„ Resumen del anÃ¡lisis:"
      echo "  - Archivo de diferencias: $(DIFF_OUTPUT)"
      if [ -f "$(DIFF_OUTPUT)" ]; then
        echo "  - TamaÃ±o: $(du -h "$(DIFF_OUTPUT)" | cut -f1)"
        echo "  - LÃ­neas: $(wc -l < "$(DIFF_OUTPUT)")"
        echo "âœ… Diff generado correctamente"
      else
        echo "âŒ ERROR: No se generÃ³ el archivo de diferencias"
        exit 1
      fi
    displayName: ðŸ“„ Mostrar Resumen

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: "$(Build.ArtifactStagingDirectory)"
      ArtifactName: "pr-diff"
      publishLocation: "Container"
    displayName: ðŸ“¦ Publicar Diff como Artefacto

  - bash: |
      echo "âœ… Pipeline completada exitosamente"
      echo "ðŸ“ El diff estÃ¡ disponible en los artefactos como 'pr-diff'"
    displayName: âœ… Completado
