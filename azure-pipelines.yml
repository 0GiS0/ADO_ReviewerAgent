# Pipeline Simplificada - Obtener Diferencias de PR
trigger: none

pr:
  branches:
    include:
      - main
      - develop
      - feature/*

pool:
  vmImage: ubuntu-latest

variables:
  - name: DIFF_OUTPUT
    value: "$(Build.ArtifactStagingDirectory)/pr-diff.txt"

steps:
  - script: echo "üöÄ Iniciando pipeline para obtener diferencias del PR"
    displayName: üöÄ Inicio

  - bash: |
      echo "üìã Informaci√≥n del Pull Request:"
      echo "  - Repository URI: $(System.PullRequest.SourceRepositoryUri)"
      echo "  - PR #: $(System.PullRequest.PullRequestId)"
      echo "  - Source Branch: $(System.PullRequest.SourceBranch)"
      echo "  - Target Branch: $(System.PullRequest.TargetBranch)"
      echo "  - Source Commit: $(System.PullRequest.SourceCommitId)"
      echo "  - Target Commit: $(System.PullRequest.TargetCommitId)"
      echo ""      
      
    displayName: üìã Mostrar Informaci√≥n del PR

  - bash: |
      echo "üì• Clonar repositorio fuente $(System.PullRequest.SourceRepositoryUri)"
      
      # Obtener la URI del repositorio fuente
      SOURCE_REPO_URI="$(System.PullRequest.SourceRepositoryUri)"
      echo "URI original: $SOURCE_REPO_URI"
      
      # Remover el protocolo https:// y el usuario existente
      TEMP_URI=$(echo $SOURCE_REPO_URI | sed 's|https://[^@]*@||')
      echo "Sin protocolo y usuario: $TEMP_URI"
      
      # Obtener el dominio (dev.azure.com)
      DOMAIN=$(echo $TEMP_URI | awk -F'/' '{print $1}')
      echo "  - DOMAIN: $DOMAIN"
      
      # Obtener la organizaci√≥n
      ORG=$(echo $TEMP_URI | awk -F'/' '{print $2}')
      echo "  - ORG: $ORG"
      
      # Obtener el proyecto (decodificar %20 a espacios)
      PROJECT=$(echo $TEMP_URI | awk -F'/' '{print $3}' | sed 's/%20/ /g')
      echo "  - PROJECT: $PROJECT"
      
      # Obtener el repositorio
      REPO=$(echo $TEMP_URI | awk -F'/' '{print $5}')
      echo "  - REPO: $REPO"

      # Montar de nuevo la URL con el PAT, codificando los espacios del proyecto
      PROJECT_ENCODED=$(echo "$PROJECT" | sed 's/ /%20/g')
      AUTHENTICATED_REPO_URI="https://$(AZURE_DEVOPS_EXT_PAT)@$DOMAIN/$ORG/$PROJECT_ENCODED/_git/$REPO"
      echo "  - AUTHENTICATED_REPO_URI: $AUTHENTICATED_REPO_URI"

      # Clonar el repositorio en el directorio source-repo
      git clone "$AUTHENTICATED_REPO_URI" source-repo || { echo "‚ùå ERROR: Fall√≥ el comando git clone"; exit 1; }


    displayName: üì• Clonar Repositorio Fuente
    env:
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)
      AZURE_DEVOPS_EXT_PAT: $(AZURE_DEVOPS_EXT_PAT)

  - bash: |
      echo "Usar git diff para ver diferencias entre ramas..."
      echo ""

      cd source-repo || { echo "‚ùå ERROR: No se pudo cambiar al directorio source-repo"; exit 1; }
      

      git fetch origin
      git --no-pager diff origin/main..origin/copilot/465 > "$(DIFF_OUTPUT)" || { echo "‚ùå ERROR: Fall√≥ el comando git diff"; exit 1; }


      echo "‚úÖ Diff generado exitosamente en: $(DIFF_OUTPUT)"
    displayName: üîç Obtener Diferencias del PR

  - bash: |
      echo "üìÑ Resumen del an√°lisis:"
      echo "  - Archivo de diferencias: $(DIFF_OUTPUT)"
      if [ -f "$(DIFF_OUTPUT)" ]; then
        echo "  - Tama√±o: $(du -h "$(DIFF_OUTPUT)" | cut -f1)"
        echo "  - L√≠neas: $(wc -l < "$(DIFF_OUTPUT)")"
        echo "‚úÖ Diff generado correctamente"
      else
        echo "‚ùå ERROR: No se gener√≥ el archivo de diferencias"
        exit 1
      fi
    displayName: üìÑ Mostrar Resumen

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: "$(Build.ArtifactStagingDirectory)"
      ArtifactName: "pr-diff"
      publishLocation: "Container"
    displayName: üì¶ Publicar Diff como Artefacto

  - bash: |
      echo "‚úÖ Pipeline completada exitosamente"
      echo "üìÅ El diff est√° disponible en los artefactos como 'pr-diff'"
    displayName: ‚úÖ Completado

  - bash: |
      echo "üîç Obteniendo diferencias usando Azure DevOps API REST..."
      
      # Extraer informaci√≥n del repositorio fuente
      SOURCE_REPO_URI="$(System.PullRequest.SourceRepositoryUri)"
      echo "URI original: $SOURCE_REPO_URI"
      
      # Remover el protocolo https:// y el usuario existente
      TEMP_URI=$(echo $SOURCE_REPO_URI | sed 's|https://[^@]*@||')
      echo "URI procesada: $TEMP_URI"
      
      # Obtener la organizaci√≥n
      ORG=$(echo $TEMP_URI | awk -F'/' '{print $2}')
      echo "  - ORGANIZATION: $ORG"
      
      # Obtener el proyecto (decodificar %20 a espacios)
      PROJECT=$(echo $TEMP_URI | awk -F'/' '{print $3}' | sed 's/%20/ /g')
      echo "  - PROJECT: $PROJECT"
      
      # Obtener el repositorio
      REPO=$(echo $TEMP_URI | awk -F'/' '{print $5}')
      echo "  - REPOSITORY: $REPO"

      # Obtener las ramas (limpiar prefijos refs/heads/ si existen)
      SOURCE_BRANCH="$(System.PullRequest.SourceBranch)"
      TARGET_BRANCH="$(System.PullRequest.TargetBranch)"
      SOURCE_BRANCH_CLEAN=$(echo "$SOURCE_BRANCH" | sed 's|refs/heads/||')
      TARGET_BRANCH_CLEAN=$(echo "$TARGET_BRANCH" | sed 's|refs/heads/||')
      
      echo "  - SOURCE BRANCH: $SOURCE_BRANCH_CLEAN"
      echo "  - TARGET BRANCH: $TARGET_BRANCH_CLEAN"
      
      # Codificar el proyecto para la URL
      PROJECT_ENCODED=$(echo "$PROJECT" | sed 's/ /%20/g')
      
      # Construir la URL de la API
      API_URL="https://dev.azure.com/$ORG/$PROJECT_ENCODED/_apis/git/repositories/$REPO/diffs/commits"
      echo "  - API URL: $API_URL"
      
      # Par√°metros de la API
      PARAMS="baseVersion=$TARGET_BRANCH_CLEAN&targetVersion=$SOURCE_BRANCH_CLEAN&api-version=7.1-preview.1"
      FULL_URL="$API_URL?$PARAMS"
      echo "  - FULL URL: $FULL_URL"
      
      echo ""
      echo "üåê Llamando a Azure DevOps API..."
      
      # Realizar la llamada a la API usando curl
      curl -s \
        -H "Authorization: Basic $(echo -n ":$(AZURE_DEVOPS_EXT_PAT)" | base64)" \
        -H "Content-Type: application/json" \
        "$FULL_URL" > "$(DIFF_OUTPUT).json" || { echo "‚ùå ERROR: Fall√≥ la llamada a la API"; exit 1; }
      
      echo "‚úÖ Respuesta de la API guardada en: $(DIFF_OUTPUT).json"
      
      # Convertir la respuesta JSON a formato diff legible
      echo ""
      echo "üìù Procesando respuesta de la API..."
      
      # Extraer informaci√≥n b√°sica del diff
      echo "üìä Resumen del diff:" > "$(DIFF_OUTPUT)"
      echo "Comparando: $TARGET_BRANCH_CLEAN -> $SOURCE_BRANCH_CLEAN" >> "$(DIFF_OUTPUT)"
      echo "Fecha: $(date)" >> "$(DIFF_OUTPUT)"
      echo "" >> "$(DIFF_OUTPUT)"
      
      # Mostrar archivos cambiados si est√°n disponibles
      if command -v jq &> /dev/null; then
        echo "üìÅ Archivos modificados:" >> "$(DIFF_OUTPUT)"
        jq -r '.changes[]?.item?.path // empty' "$(DIFF_OUTPUT).json" | sort | uniq >> "$(DIFF_OUTPUT)" 2>/dev/null || echo "No se pudieron extraer los archivos modificados" >> "$(DIFF_OUTPUT)"
        echo "" >> "$(DIFF_OUTPUT)"
        
        echo "üîç Detalles de los cambios:" >> "$(DIFF_OUTPUT)"
        jq -r '.changes[]? | "Archivo: \(.item.path // "unknown")\nTipo de cambio: \(.changeType // "unknown")\n"' "$(DIFF_OUTPUT).json" >> "$(DIFF_OUTPUT)" 2>/dev/null || echo "No se pudieron extraer los detalles de cambios" >> "$(DIFF_OUTPUT)"
      else
        echo "‚ö†Ô∏è  jq no est√° disponible, guardando respuesta JSON completa" >> "$(DIFF_OUTPUT)"
        cat "$(DIFF_OUTPUT).json" >> "$(DIFF_OUTPUT)"
      fi
      
      echo ""
      echo "‚úÖ Diff procesado y guardado en: $(DIFF_OUTPUT)"
      
    displayName: üåê Obtener Diferencias usando API REST

  - bash: |
      echo "üìÑ Resumen del an√°lisis:"
      echo "  - Archivo JSON de la API: $(DIFF_OUTPUT).json"
      echo "  - Archivo de diferencias procesado: $(DIFF_OUTPUT)"
      
      if [ -f "$(DIFF_OUTPUT)" ]; then
        echo "  - Tama√±o del diff: $(du -h "$(DIFF_OUTPUT)" | cut -f1)"
        echo "  - L√≠neas: $(wc -l < "$(DIFF_OUTPUT)")"
        echo "‚úÖ Diff generado correctamente usando API REST"
        
        echo ""
        echo "üìã Primeras l√≠neas del diff:"
        head -20 "$(DIFF_OUTPUT)"
      else
        echo "‚ùå ERROR: No se gener√≥ el archivo de diferencias"
        exit 1
      fi
      
      if [ -f "$(DIFF_OUTPUT).json" ]; then
        echo ""
        echo "üìä Tama√±o de la respuesta JSON: $(du -h "$(DIFF_OUTPUT).json" | cut -f1)"
      fi
    displayName: üìÑ Mostrar Resumen de API
