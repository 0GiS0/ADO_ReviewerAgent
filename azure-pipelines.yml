# Pipeline de RevisiÃ³n de PR con GitHub Copilot
trigger: none

pr:
  branches:
    include:
      - main
      - develop
      - feature/*

pool:
  vmImage: ubuntu-latest

variables:
  - group: "GitHub Copilot CLI"
  - name: REVIEW_OUTPUT
    value: "$(Build.ArtifactStagingDirectory)/review-report.md"
  - name: COPILOT_VERSION
    value: "0.0.339"
  - name: MODEL
    value: claude-sonnet-4

steps:
  - script: echo "ğŸš€ PR Review pipeline started!"
    displayName: ğŸš€ Start Pipeline

  - checkout: self
    fetchDepth: "0"
    persistCredentials: "true"
    displayName: ğŸ“¥ Checkout Code

  - task: NodeTool@0
    inputs:
      versionSource: "spec"
      versionSpec: "22.x"
    displayName: âš™ï¸ Setup Node.js 22.x

  - bash: |
      NPM_PREFIX=$(npm config get prefix)
      echo "##vso[task.setvariable variable=NPM_GLOBAL_PATH]${NPM_PREFIX}/lib/node_modules"
      echo "NPM global path: ${NPM_PREFIX}/lib/node_modules"
    displayName: ğŸ” Detect NPM Global Path

  - task: Cache@2
    inputs:
      key: 'npm-global | "$(Agent.OS)" | "copilot" | "$(COPILOT_VERSION)"'
      path: $(NPM_GLOBAL_PATH)
      restoreKeys: |
        npm-global | "$(Agent.OS)" | "copilot"
    displayName: ğŸ“¦ Cache Global NPM Packages

  - bash: |
      if ! command -v copilot &> /dev/null; then
        echo "Installing @github/copilot..."
        npm install -g @github/copilot
      else
        echo "âœ… @github/copilot already installed (from cache)"
        copilot --version
      fi
    displayName: ğŸ“¦ Install Copilot CLI

  - template: templates/run-script.yml
    parameters:
      script: get-changed-files.sh
      displayName: ğŸ“‹ Get Changed Files

  - template: templates/run-script.yml
    parameters:
      script: analyze-changes.sh
      displayName: ğŸ” Analyze Changes with Copilot

  - bash: |
      echo "=== REPORTE DE REVISIÃ“N ==="
      cat $(REVIEW_OUTPUT)
      echo "==========================="
    displayName: ğŸ“„ Show Report

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: "$(Build.ArtifactStagingDirectory)"
      ArtifactName: "copilot-review"
      publishLocation: "Container"
    displayName: ğŸ“¦ Publish Report as Artifact

  - template: templates/run-script.yml
    parameters:
      script: post-pr-comment.sh
      args: '"$(REVIEW_OUTPUT)" "$(System.CollectionUri)" "$(System.TeamProject)" "$(Build.Repository.ID)" "$(System.PullRequest.PullRequestId)"'
      displayName: ğŸ’¬ Post Summary Comment
      env:
        AZURE_DEVOPS_EXT_PAT: $(AZURE_DEVOPS_EXT_PAT)

  - template: templates/run-script.yml
    parameters:
      script: post-recommendations.sh
      args: '"./logs/copilot_recommendations.md" "$(System.CollectionUri)" "$(System.TeamProject)" "$(Build.Repository.ID)" "$(System.PullRequest.PullRequestId)"'
      displayName: ğŸ’¬ Post Individual Recommendations
      env:
        AZURE_DEVOPS_EXT_PAT: $(AZURE_DEVOPS_EXT_PAT)

  - bash: |
      echo "âœ… PR Review completed successfully"
      echo "ğŸ“Š Review report available in artifacts"
      echo "ğŸ’¬ Comments posted to PR #$(System.PullRequest.PullRequestId)"
    displayName: âœ… Complete
    condition: succeeded()
