#!/bin/bash

# Test script to post a simple test comment to a PR
# Usage: ./test-pr-comment.sh <ORGANIZATION> <PROJECT> <REPOSITORY> <PR_ID> <PAT>

echo "ğŸ§ª TEST: Posting test comment to PR"
echo "=================================="

# Check parameters
if [ $# -ne 5 ]; then
    echo "âŒ ERROR: Incorrect number of parameters"
    echo "Usage: $0 <ORGANIZATION> <PROJECT> <REPOSITORY> <PR_ID> <PAT>"
    echo ""
    echo "Example:"
    echo "$0 'returngisorg' 'GitHub Copilot CLI' 'Demo' '113' 'your-pat'"
    exit 1
fi

# Assign parameters
ORGANIZATION="$1"
PROJECT="$2"
REPOSITORY="$3"
PR_ID="$4"
PAT="$5"

echo "ğŸ“‹ Test Configuration:"
echo "  - Organization: $ORGANIZATION"
echo "  - Project: $PROJECT"
echo "  - Repository: $REPOSITORY"
echo "  - PR ID: $PR_ID"
echo ""

# Create a simple test comment
TEST_COMMENT="ğŸ¤– **PR Analysis Test Comment**

This is a test comment generated by the PR analysis pipeline to verify API connectivity and authentication.

**Test Details:**
- Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
- Pipeline Build: Test Run
- Status: Testing API connection

âœ… If you can see this comment, the API integration is working correctly!"

echo "ğŸ“ Test comment created ($(echo "$TEST_COMMENT" | wc -c) characters)"

# Encode project name for URL
PROJECT_ENCODED=$(echo "$PROJECT" | sed 's/ /%20/g')

# Build API URL
API_URL="https://dev.azure.com/$ORGANIZATION/$PROJECT_ENCODED/_apis/git/repositories/$REPOSITORY/pullRequests/$PR_ID/threads?api-version=7.1"
echo "ğŸ”— API URL: $API_URL"

# Escape content for JSON
ESCAPED_CONTENT=$(echo "$TEST_COMMENT" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

# Create JSON payload
PAYLOAD_FILE="/tmp/test-pr-comment-payload-$$.json"
cat > "$PAYLOAD_FILE" << EOF
{
  "comments": [
    {
      "parentCommentId": 0,
      "content": "$ESCAPED_CONTENT",
      "commentType": 1
    }
  ],
  "status": 1
}
EOF

echo "ğŸ“Š Payload size: $(wc -c < "$PAYLOAD_FILE") bytes"

# Generate authentication header
AUTH_HEADER=$(printf "%s:" "$PAT" | base64)
echo "ğŸ”‘ Auth header generated (length: ${#AUTH_HEADER} characters)"

# Test basic connectivity
echo ""
echo "ğŸŒ Testing connectivity to Azure DevOps..."
CONNECTIVITY_TEST=$(curl -s -w "HTTPSTATUS:%{http_code}" -I "https://dev.azure.com/$ORGANIZATION" --connect-timeout 10)
CONNECT_CODE=$(echo "$CONNECTIVITY_TEST" | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
echo "ğŸ“¡ Connectivity test: $CONNECT_CODE"

if [ "$CONNECT_CODE" != "200" ] && [ "$CONNECT_CODE" != "302" ]; then
    echo "âš ï¸  Connectivity test didn't return 200/302, but proceeding with API call..."
fi

# Make API call
echo ""
echo "ğŸš€ Making test API call..."
HTTP_RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" \
  --connect-timeout 30 \
  --max-time 60 \
  -X POST \
  -H "Authorization: Basic $AUTH_HEADER" \
  -H "Content-Type: application/json" \
  -H "Accept: application/json" \
  -d @"$PAYLOAD_FILE" \
  "$API_URL")

# Parse response
HTTP_CODE=$(echo "$HTTP_RESPONSE" | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
RESPONSE_BODY=$(echo "$HTTP_RESPONSE" | sed 's/HTTPSTATUS:[0-9]*$//')

echo "ğŸ“¡ HTTP Response Code: $HTTP_CODE"

# Clean up
rm -f "$PAYLOAD_FILE"

# Process response
case "$HTTP_CODE" in
    200|201)
        echo "âœ… TEST PASSED: Comment posted successfully!"
        
        # Try to extract thread ID if jq is available
        if command -v jq &> /dev/null && echo "$RESPONSE_BODY" | jq empty 2>/dev/null; then
            THREAD_ID=$(echo "$RESPONSE_BODY" | jq -r '.id // "N/A"')
            COMMENT_ID=$(echo "$RESPONSE_BODY" | jq -r '.comments[0].id // "N/A"')
            echo "ğŸ“Œ Thread ID: $THREAD_ID"
            echo "ğŸ’¬ Comment ID: $COMMENT_ID"
        fi
        
        # Build PR URL
        PR_URL="https://dev.azure.com/$ORGANIZATION/$PROJECT_ENCODED/_git/$REPOSITORY/pullrequest/$PR_ID"
        echo ""
        echo "ğŸ”— View comment at: $PR_URL"
        echo ""
        echo "ğŸ‰ API integration test completed successfully!"
        ;;
    400)
        echo "âŒ TEST FAILED: Bad Request (400)"
        echo "Possible causes:"
        echo "  - Invalid JSON payload"
        echo "  - Missing required fields"
        echo "  - PR ID doesn't exist: $PR_ID"
        echo ""
        echo "ğŸ“‹ Response body (first 500 chars):"
        echo "$RESPONSE_BODY" | head -c 500
        exit 1
        ;;
    401)
        echo "âŒ TEST FAILED: Unauthorized (401)"
        echo "Possible causes:"
        echo "  - PAT is invalid or expired"
        echo "  - PAT doesn't have required permissions"
        echo "  - Incorrect organization/project"
        exit 1
        ;;
    403)
        echo "âŒ TEST FAILED: Forbidden (403)"
        echo "Possible causes:"
        echo "  - PAT lacks sufficient permissions"
        echo "  - User doesn't have access to repository"
        echo "  - Branch policies prevent comments"
        exit 1
        ;;
    404)
        echo "âŒ TEST FAILED: Not Found (404)"
        echo "Possible causes:"
        echo "  - PR ID doesn't exist: $PR_ID"
        echo "  - Repository incorrect: $REPOSITORY"
        echo "  - Project incorrect: $PROJECT"
        echo "  - Organization incorrect: $ORGANIZATION"
        exit 1
        ;;
    000|"")
        echo "âŒ TEST FAILED: No HTTP response (000 or empty)"
        echo "Possible causes:"
        echo "  - Network connectivity issues"
        echo "  - DNS resolution failure"
        echo "  - Curl command failed"
        echo "  - Timeout occurred"
        echo ""
        echo "ğŸ” Full response:"
        echo "$HTTP_RESPONSE"
        
        # Additional network tests
        echo ""
        echo "ğŸŒ Additional network diagnostics:"
        if curl -s --connect-timeout 5 --head "https://httpbin.org/get" > /dev/null; then
            echo "âœ… General internet connectivity: OK"
        else
            echo "âŒ General internet connectivity: FAILED"
        fi
        
        if curl -s --connect-timeout 5 --head "https://dev.azure.com" > /dev/null; then
            echo "âœ… Azure DevOps reachability: OK"
        else
            echo "âŒ Azure DevOps reachability: FAILED"
        fi
        
        exit 1
        ;;
    *)
        echo "âŒ TEST FAILED: Unexpected HTTP code: $HTTP_CODE"
        echo ""
        echo "ğŸ“‹ Response body:"
        echo "$RESPONSE_BODY"
        exit 1
        ;;
esac

echo ""
echo "ğŸ§ª Test completed successfully!"